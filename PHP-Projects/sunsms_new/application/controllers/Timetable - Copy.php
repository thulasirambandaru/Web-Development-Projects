<?php/**Time Table Module - Create, Update, Read, Delete Operations.
**/
class Timetable extends CI_Controller {
    public function __construct()
    {
        parent::__construct();		$this->load->library('Datatables');
        $this->load->model("mwelcome");
        if($this->session->userdata('user_id') && $this->session->userdata('user_type_id')==2){}
        else{
            redirect(BASE_URL);
        }
    }
    function index()
    {
        $data['header']="header";
        $data['left_menu']="left_menu";
        $data['middle_content']='timetable/time_table';
        $data['footer']='footer';
        $data['menu'] = 'timetable';
        $this->load->view('landing',$data);
    }		/*function timeTable()	{		$data['header']="header";		$data['left_menu']="left_menu";		$data['middle_content']='admin/time_table';		$data['footer']='footer';		$data['menu'] = 'settings';		$this->load->view('landing',$data);	}*/	function getClassTimeTableDataTable()	{		$results = json_decode($this->mwelcome->getClassTimeTableDataTable($_POST));		for($s=0;$s<count($results->data);$s++)		{			$results->data[$s][4] = encode($results->data[$s][4]);		}		echo json_encode($results);	}	function addTimetable($class_time_table=0)	{		if($class_time_table===0){}		else{			$data['class_timing'] = $this->mwelcome->getClassTimeTable(array('id_class_time_table' => decode($class_time_table),'school_id' => $this->session->userdata('school_id')));			$days = $this->mwelcome->getWeekDay(array('school_id' => $this->session->userdata('school_id'),'status' => 1));			$timings = $this->mwelcome->getClassTiming(array('course_id' => $data['class_timing'][0]['course_id'],'school_id' => $this->session->userdata('school_id')));			if(empty($timings)){				$html = '<p>There are no timings for this class <a href="'.BASE_URL.'index.php/admin/addClassTiming">Create Class Timing</a></p>';			}			else			{				$data['edit'] = 1;				$html='<table class="table table-bordered"><tr><th>WeekDays</th>';				for($s=0;$s<count($timings);$s++){					$html.='<th>'.date('g:i a', strtotime($timings[$s]['start_time'])).' '.date('g:i a', strtotime($timings[$s]['end_time'])).'</th>';				}				$html.='</tr><tbody>';				for($s=0;$s<count($days);$s++)				{	$html.='<tr><td>'.week_days($days[$s]['day']).'</td>';					for($r=0;$r<count($timings);$r++)					{						if($timings[$r]['is_break']==1)						{							$html.='<td><div>Break</div><input type="hidden" name="time_id_day_id[]" value="'.$timings[$r]['id_class_timing'].'@@@'.$days[$s]['day'].'"></td>';						}						else{							$sub_tea = $this->mwelcome->getTimeTableData(array('class_time_table_id' => $data['class_timing'][0]['id_class_time_table'],'class_timing_id' => $timings[$r]['id_class_timing'],'day_id' => $days[$s]['day']));							if($sub_tea[0]['id_staff']=='' && $sub_tea[0]['id_subject']=='')								$html.='<td><div><a href="javascript:;" onclick="getAssign(this,\''.$timings[$r]['id_class_timing'].'_'.$days[$s]['day'].'\');" data-toggle="modal" data-target="#myModal">Assign</a></div><input type="hidden" name="time_id_day_id[]" value="'.$timings[$r]['id_class_timing'].'@@@'.$days[$s]['day'].'"></td>';							else{								$html.='<td><div><div><span onclick="reAssign(this,\''.$timings[$r]['id_class_timing'].'_'.$days[$s]['day'].'\')" style="cursor: pointer;">X</span><p>'.$sub_tea[0]["first_name"].' '.$sub_tea[0]["last_name"].'</p><p>'.$sub_tea[0]["subject_name"].'</p><input type="hidden" value="'.$sub_tea[0]['id_staff'].'-'.$sub_tea[0]['id_subject'].'" name="t_'.$timings[$r]['id_class_timing'].'_'.$days[$s]['day'].'"></div></div><input type="hidden" name="time_id_day_id[]" value="'.$timings[$r]['id_class_timing'].'@@@'.$days[$s]['day'].'"></td>';							}						}					}					$html.='</tr>';				}				$html.='</table>';			}			$data['html'] = $html;		}		$data['course'] = $this->mwelcome->getCourse(array('school_id' => $this->session->userdata('school_id'),'status' => 1));		$data['header']="header";		$data['left_menu']="left_menu";		$data['middle_content']='timetable/add_time_table';		$data['footer']='footer';		$data['menu'] = 'timetable';		$this->load->view('landing',$data);	}	function getTimeTable()	{		if(isset($_POST))		{			$days = $this->mwelcome->getWeekDay(array('school_id' => $this->session->userdata('school_id'),'status' => 1));			$timings = $this->mwelcome->getClassTiming(array('course_id' => $_POST['class_id'],'school_id' => $this->session->userdata('school_id')));			if(empty($timings)){				echo json_encode(array('response' => 2, 'data' => '')); exit;			}			else			{				$html='<table class="table table-bordered"><tr><th>WeekDays</th>';				for($s=0;$s<count($timings);$s++){					$html.='<th>'.date('g:i a', strtotime($timings[$s]['start_time'])).' '.date('g:i a', strtotime($timings[$s]['end_time'])).'</th>';				}				$html.='</tr><tbody>';				for($s=0;$s<count($days);$s++)				{	$html.='<tr><td>'.week_days($days[$s]['day']).'</td>';					for($r=0;$r<count($timings);$r++)					{						if($timings[$r]['is_break']==0)							$html.='<td><div><a href="javascript:;" onclick="getAssign(this,\''.$timings[$r]['id_class_timing'].'_'.$days[$s]['day'].'\');" data-toggle="modal" data-target="#myModal">Assign</a></div><input type="hidden" name="time_id_day_id[]" value="'.$timings[$r]['id_class_timing'].'@@@'.$days[$s]['day'].'"></td>';						else							$html.='<td><div>Break</div><input type="hidden" name="time_id_day_id[]" value="'.$timings[$r]['id_class_timing'].'@@@'.$days[$s]['day'].'"></td>';					}					$html.='</tr>';				}				$html.='</table>';				echo json_encode(array('response' => 1, 'data' => $html)); exit;			}		}	}	function getStaffSubject()	{		if(isset($_POST)){			$staff = $this->mwelcome->getStaff(/*array('school_id' => $this->session->userdata('school_id'))*/);			$subject = $this->mwelcome->getSubject(array('course_id' => $_POST['course_id'],'status' => 1));			echo json_encode(array('response' => 1, 'staff' => $staff, 'subject' => $subject));		}	}	function createTimeTable()	{		if(!$_POST['id_class_time_table'])		{			$data = array();			$class_time_table_id = $this->mwelcome->addClassTimeTable(array('course_id' => $_POST['course_id'],'start_date' => date('Y-m-d',strtotime($_POST['start_date'])),'end_date' => date('Y-m-d',strtotime($_POST['end_date']))));			for($s=0;$s<count($_POST['time_id_day_id']);$s++)			{				$t_s = explode('@@@',$_POST['time_id_day_id'][$s]);				if(isset($_POST['t_'.$t_s[0].'_'.$t_s[1]])){					$s_t = explode('-',$_POST['t_'.$t_s[0].'_'.$t_s[1]]);				}				else{					$s_t[0] = '';					$s_t[1] = '';				}				$data[] = array(					'class_time_table_id' => $class_time_table_id,					'class_timing_id' => $t_s[0],					'day_id' => $t_s[1],					'subject_id' => $s_t[1],					'teacher_id' => $s_t[0],				);			}			$this->mwelcome->addTimeTable($data);			redirect(BASE_URL.'index.php/Timetable/index');		}		else		{			$class_time_table_id = decode($_POST['id_class_time_table']);			$this->mwelcome->updateClassTimeTable(array('id_class_time_table' => $class_time_table_id,'course_id' => $_POST['course_id'],'start_date' => date('Y-m-d',strtotime($_POST['start_date'])),'end_date' => date('Y-m-d',strtotime($_POST['end_date']))));			for($s=0;$s<count($_POST['time_id_day_id']);$s++)			{				$t_s = explode('@@@',$_POST['time_id_day_id'][$s]);				if(isset($_POST['t_'.$t_s[0].'_'.$t_s[1]])){					$s_t = explode('-',$_POST['t_'.$t_s[0].'_'.$t_s[1]]);				}				else{					$s_t[0] = '';					$s_t[1] = '';				}				$exe_time_table = $this->mwelcome->getTimeTableData(array('class_time_table_id' => $class_time_table_id,'class_timing_id' => $t_s[0],'day_id' => $t_s[1]));				$data[] = array(					'id_time_table' => $exe_time_table[0]['id_time_table'],					'subject_id' => $s_t[1],					'teacher_id' => $s_t[0],				);			}			$this->mwelcome->updateTimeTable($data);			redirect(BASE_URL.'index.php/Timetable/index');		}	}	function deleteClassTimeTable($id)	{		$this->mwelcome->deleteTimeTable(decode($id));		$this->mwelcome->deleteClassTimeTable(decode($id));		echo json_encode(array('response' => 1,'data' =>''));	}
}